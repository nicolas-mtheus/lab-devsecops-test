name: ðŸ›¡ï¸ DevSecOps Security Gate

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  security-analysis:
    name: Security Analysis
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ” Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 1. Gitleaks (Secrets)
      - name: ðŸ”‘ Gitleaks Scan
        id: gitleaks
        run: |
          echo "### ðŸ”‘ RelatÃ³rio de Secrets (Gitleaks)" >> $GITHUB_STEP_SUMMARY
          docker run --rm -v $(pwd):/path zricethezav/gitleaks:latest detect --source="/path" --verbose --redact >> $GITHUB_STEP_SUMMARY || echo "âŒ Leaks encontrados!" >> $GITHUB_STEP_SUMMARY

      # 2. Semgrep (SAST)
      - name: ðŸ›¡ï¸ Semgrep Scan
        id: semgrep
        run: |
          echo "### ðŸ›¡ï¸ RelatÃ³rio SAST (Semgrep)" >> $GITHUB_STEP_SUMMARY
          docker run --rm -v $(pwd):/src returntocorp/semgrep semgrep \
          --config=p/java --config=p/typescript --config=p/security-audit --error >> $GITHUB_STEP_SUMMARY || echo "âŒ Falhas de cÃ³digo encontradas!" >> $GITHUB_STEP_SUMMARY

      # 3. Trivy (SCA)
      - name: ðŸ“¦ Trivy Dependency Scan
        id: trivy
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'fs'
          scanners: 'vuln'
          format: 'table'
          output: 'trivy-report.txt'
          exit-code: '1'
          severity: 'CRITICAL,HIGH'

      # 4. Publicar RelatÃ³rio do Trivy se ele falhar
      - name: ðŸ“‹ Publish Trivy Summary
        if: failure()
        run: |
          echo "### ðŸ“¦ RelatÃ³rio de DependÃªncias (Trivy)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat trivy-report.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      # Passo Final: ForÃ§ar a falha se qualquer um anterior falhou (jÃ¡ que usamos logs)
      - name: ðŸ›‘ Check for Failures
        if: steps.gitleaks.outcome == 'failure' || steps.semgrep.outcome == 'failure' || steps.trivy.outcome == 'failure'
        run: |
          echo "A pipeline encontrou vulnerabilidades crÃ­ticas. Verifique o resumo (Summary) da Action."
          exit 1